---
title: 压力测试与性能测试
date: 2022-05-12
tags:
 - 压力测试
categories:
 - 工具栈
---
<!-- TOC -->

- [压力测试](#%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95)
    - [压力测试的必要性](#%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%E7%9A%84%E5%BF%85%E8%A6%81%E6%80%A7)
    - [压力测试的性能指标](#%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%E7%9A%84%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87)
    - [安装使用 JMeter](#%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8-jmeter)
    - [使用 JMeter 压力测试](#%E4%BD%BF%E7%94%A8-jmeter-%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95)
        - [添加线程组](#%E6%B7%BB%E5%8A%A0%E7%BA%BF%E7%A8%8B%E7%BB%84)
        - [添加取样器](#%E6%B7%BB%E5%8A%A0%E5%8F%96%E6%A0%B7%E5%99%A8)
        - [添加查看结果树](#%E6%B7%BB%E5%8A%A0%E6%9F%A5%E7%9C%8B%E7%BB%93%E6%9E%9C%E6%A0%91)
        - [添加汇总报告](#%E6%B7%BB%E5%8A%A0%E6%B1%87%E6%80%BB%E6%8A%A5%E5%91%8A)
        - [添加聚合报告](#%E6%B7%BB%E5%8A%A0%E8%81%9A%E5%90%88%E6%8A%A5%E5%91%8A)
- [性能监控](#%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7)
    - [性能优化的方向](#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E7%9A%84%E6%96%B9%E5%90%91)
    - [JVM 内存模型](#jvm-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B)
    - [堆](#%E5%A0%86)
    - [利用 jconsole 监控 JVM](#%E5%88%A9%E7%94%A8-jconsole-%E7%9B%91%E6%8E%A7-jvm)
    - [利用 jvisualvm 监控 JVM](#%E5%88%A9%E7%94%A8-jvisualvm-%E7%9B%91%E6%8E%A7-jvm)
        - [监控](#%E7%9B%91%E6%8E%A7)
        - [调优](#%E8%B0%83%E4%BC%98)
- [性能优化实践](#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E8%B7%B5)
    - [直接访问微服务与 myslq 交互](#%E7%9B%B4%E6%8E%A5%E8%AE%BF%E9%97%AE%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%8E-myslq-%E4%BA%A4%E4%BA%92)
    - [访问网关查询微服务与 mysql 交互](#%E8%AE%BF%E9%97%AE%E7%BD%91%E5%85%B3%E6%9F%A5%E8%AF%A2%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%B8%8E-mysql-%E4%BA%A4%E4%BA%92)
    - [直接访问微服务带缓存 redis](#%E7%9B%B4%E6%8E%A5%E8%AE%BF%E9%97%AE%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%B8%A6%E7%BC%93%E5%AD%98-redis)
    - [访问网关查询微服务带缓存 redis](#%E8%AE%BF%E9%97%AE%E7%BD%91%E5%85%B3%E6%9F%A5%E8%AF%A2%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%B8%A6%E7%BC%93%E5%AD%98-redis)

<!-- /TOC -->

# 压力测试

## 压力测试的必要性

考察基于当前软硬件环境下，系统所能承受的最大负荷并帮助找出系统瓶颈所在。压测是为了系统在线上的处理能力和稳定性维持在一个标准范围内，做到心中有数。

使用压力测试， 我们有希望找到很多种用其他测试方法更难发现的错误。 有两种错误类型是: 内存泄漏， 并发与同步。

有效的压力测试系统将应用以下这些关键条件:

重复， 并发， 量级， 随机变化。

## 压力测试的性能指标

通常评价性能的三个指标：吞吐量：TPS 与 QPS、响应时间、错误率

- 响应时间（Response Time: RT）：指用户从客户端发起一个请求开始， 到客户端接收到从服务器端返回的响应结束， 整个过程所耗费的时间；

- TPS（Transaction per Second） ： 系统每秒处理交易数， 单位是笔/秒；

- QPS（Query per Second） ： 系统每秒处理查询次数， 单位是次/秒；

- HPS（Hits Per Second） ： 每秒点击次数， 单位是次/秒；

无论 TPS、 QPS、 HPS,此指标是衡量系统处理能力非常重要的指标， 越大越好， 根据经
验， 一般情况下：

- 金融行业： 1000TPS~50000TPS， 不包括互联网化的活动
- 保险行业： 100TPS~100000TPS， 不包括互联网化的活动
- 制造行业： 10TPS~5000TPS
- 互联网电子商务： 10000TPS~1000000TPS
- 互联网中型网站： 1000TPS~50000TPS
- 互联网小型网站： 500TPS~10000TPS

## 安装使用 JMeter

1. 通过官网下载 [JMeter](https://jmeter.apache.org/download_jmeter.cgi)

2. 启动 jmeter.bat 文件

## 使用 JMeter 压力测试 

### 添加线程组

软件参数解析：

- 线程组中输入的线程数：指并发用户访问数量；

- Ramp-Up 时间：每秒启动的线程数，总共线程数为输入线程总数；

- 循环次数：表明每个线程需要发请求的次数；

- 总请求数： 线程数 * 循环次数；

### 添加取样器

指定参数：
- 协议
- 服务器 IP
- 端口号
- 请求类型

### 添加查看结果树

### 添加汇总报告

- 样本：总请求数
- 平均值：所有请求平均响应时间,时间单位 ms
- 最小值：最小响应时间
- 标准偏差：偏差大说明不稳定

### 添加聚合报告

- 平均值：所有请求平均响应时间；
- 中位数：大多数请求响应的时间；

# 性能监控

## 性能优化的方向

首先考虑 CPU 密集型还是 IO 密集型(内存、硬盘占用)

- 数据库：数据库的 Sql 语句是否高效；
- 应用程序：编写的代码效率
- 中间件：请求 -> nginx -> 网关 -> 微服务 
- 网络带宽
- 操作系统

## JVM 内存模型

JVM 是 C 语言编写的, 在 JVM 内存模型中，内存分为运行时数据区和本地内存。

运行时数据又包括线程之间共享的内存和私有的内存
- 线程共享包括 堆区 和 方法区
- 线程私有(隔离的)包括 栈区 和 计数器

<img src="https://javaguide.cn/assets/Java%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA%E5%9F%9FJDK1.8.dbbe1f77.png"></img>

## 堆

<img src="https://javaguide.cn/assets/hotspot-heap-structure.784465da.png"></img>

jdk 1.8 之后 堆区分为:

- 新生代：伊甸园区、幸存者0、幸存者 1 区，
- 老年代，
- 元空间

过程简介：

当新建对象后，将为对象在新生代中的伊甸园区开辟一段内存，
(1) 伊甸园区内存充足，直接开辟内存；
(2) 如果伊甸园区内存不足，将开始一次 minorGC 操作，此 GC 过程较快，目的是将伊甸园区的垃圾对象回收到幸存者区，如果此时伊甸园区内存足够了，则开辟内存存储对象；
(3) 如果内存仍然不足，进行一次 fullGC 操作，此 GC 过程较慢，影响效率，目的是给老年代的垃圾对象进行一次大清理,如果此时伊甸园区内存足够了，则开辟内存存储对象；
(4) 如果内存仍然不够，爆 OOM 异常；

## 利用 jconsole 监控 JVM

在cmd 终端输入 jconsole 进入，监控某一端口堆的使用；

## 利用 jvisualvm 监控 JVM

### 监控

在cmd 终端输入 jvisualvm  进入，监控某一端口堆的使用；

一些参数：

- 运行： 正在运行的
- 休眠： sleep
- 等待： wait
- 驻留： 线程池里面的空闲线程
- 监视： 阻塞的线程， 正在等待锁

### 调优

1. 中间件越多，性能损失越快;
2. 避免频繁的数据库交互，同时交互时数据库的速度可通过建立索引提高;
3. 给新生代和老年代适度的内存空间，避免内存太小不断 GC 操作;

# 性能优化实践

## 直接访问微服务(与 myslq 交互)

- 网址：http://localhost:10000/product/category/list/tree

- 启用线程数 50， 循环次数 20

```xml
表格        样本    平均值  中位数   90%     95%     99%    最小、最大   异常   吞吐量/sec           接收 KB/sec         发送 KB/sec
HTTP请求	1000	1822	1823	2128	2437	3434	84	7854	0.0	   25.52843868069029	5271.2486358240585	3.639796921270295
总体	    1000	1822	1823	2128	2437	3434	84	7854	0.0	   25.52843868069029	5271.2486358240585	3.639796921270295
```

## 访问网关查询微服务(与 mysql 交互)

- 网址：http://localhost:88/api/product/category/list/tree

- 启用线程数 50， 循环次数 20

```xml
表格        样本    平均值  中位数   90%     95%     99%    最小、最大   异常    吞吐量/sec           接收 KB/sec         发送 KB/sec
HTTP请求	1000	1841	1844	2285	2476	2908	202	3924	0.0	    25.49134568813888	5267.936148958679	3.659402164215249
总体	    1000	1841	1844	2285	2476	2908	202	3924	0.0	    25.49134568813888	5267.936148958679	3.659402164215249
```

## 直接访问微服务(带缓存 redis)

- 网址：http://localhost:10000/product/category/list/tree

- 启用线程数 50， 循环次数 20

```xml
表格        样本    平均值  中位数   90%     95%     99%    最小、最大   异常   吞吐量/sec           接收 KB/sec         发送 KB/sec
HTTP请求	1000	28	    21	    60	    70	     93	    7	 194	0.0    651.0416666666666	134430.5674235026	92.82430013020833
总体	    1000	28	    21	    60	    70	     93	    7	 194	0.0	   651.0416666666666	134430.5674235026	92.82430013020833
```

## 访问网关查询微服务(带缓存 redis)

- 网址：http://localhost:88/api/product/category/list/tree

- 启用线程数 50， 循环次数 20

```xml
表格        样本    平均值  中位数   90%     95%     99%    最小、最大   异常    吞吐量/sec           接收 KB/sec         发送 KB/sec
HTTP请求	1000	70	    56	    136	    177	    249	    9	410	    0.0	    417.5365344467641	86290.17810542797	59.9393267223382
总体	    1000	70	    56	    136	    177	    249	    9	410	    0.0	    417.5365344467641	86290.17810542797	59.9393267223382
```

